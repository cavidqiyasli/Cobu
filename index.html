<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>2D QuÅŸ BaxÄ±ÅŸÄ± Oyun (Multiplayer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; background: #111; overflow: hidden; }
    canvas { display: block; margin: auto; }
  </style>

  <!-- Phaser kitabxanasÄ± -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

  <!-- Socket.io (server É™laqÉ™si Ã¼Ã§Ã¼n) -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
<script>
const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  backgroundColor: '#222',
  physics: {
    default: 'arcade',
    arcade: { debug: false }
  },
  scene: { preload, create, update }
};

let player;
let bullets;
let keys;
let lastFired = 0;
let others = {}; // digÉ™r oyunÃ§ular

// âš¡ ServerÉ™ qoÅŸul
const socket = io("https://cobu.onrender.com");

const game = new Phaser.Game(config);

function preload() {}

function create() {
  const scene = this;

  // Oyuncu (yaÅŸÄ±l dairÉ™)
  player = scene.add.circle(400, 300, 20, 0x00ff00);
  scene.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);

  // GÃ¼llÉ™ qrupu
  bullets = scene.physics.add.group();

  // Klaviatura idarÉ™si
  keys = scene.input.keyboard.addKeys({
    up: 'W', down: 'S', left: 'A', right: 'D'
  });

  // Maus hÉ™rÉ™kÉ™ti - baxÄ±ÅŸ istiqamÉ™ti
  scene.input.on('pointermove', pointer => {
    const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
    player.rotation = angle;
  });

  // Sol kliklÉ™ atÉ™ÅŸ
  scene.input.on('pointerdown', pointer => {
    shoot(scene, pointer);
  });

  // ðŸ”¹ ServerÉ™ yeni oyunÃ§u kimi mÉ™lumat gÃ¶ndÉ™r
  socket.emit("newPlayer", { x: player.x, y: player.y });

  // ðŸ”¹ Yeni oyunÃ§u qoÅŸulanda
  socket.on("playerJoined", data => {
    if (!others[data.id]) {
      const other = scene.add.circle(data.x, data.y, 20, 0x0000ff);
      others[data.id] = other;
    }
  });

  // ðŸ”¹ DigÉ™r oyunÃ§ularÄ±n mÃ¶vqelÉ™ri yenilÉ™nÉ™ndÉ™
  socket.on("positions", players => {
    for (let id in players) {
      if (id !== socket.id) {
        if (!others[id]) {
          others[id] = scene.add.circle(players[id].x, players[id].y, 20, 0x0000ff);
        } else {
          others[id].x = players[id].x;
          others[id].y = players[id].y;
        }
      }
    }
  });

  // ðŸ”¹ OyunÃ§u Ã§Ä±xanda
  socket.on("playerLeft", id => {
    if (others[id]) {
      others[id].destroy();
      delete others[id];
    }
  });
}

function update(time) {
  const speed = 250;
  player.body.setVelocity(0);

  if (keys.left.isDown) player.body.setVelocityX(-speed);
  if (keys.right.isDown) player.body.setVelocityX(speed);
  if (keys.up.isDown) player.body.setVelocityY(-speed);
  if (keys.down.isDown) player.body.setVelocityY(speed);

  // ðŸ”¹ HÉ™r saniyÉ™ Ã¶z mÃ¶vqeyini serverÉ™ gÃ¶ndÉ™r
  socket.emit("move", { x: player.x, y: player.y });
}

// AtÉ™ÅŸ funksiyasÄ±
function shoot(scene, pointer) {
  const bullet = scene.add.circle(player.x, player.y, 5, 0xff0000);
  scene.physics.add.existing(bullet);

  const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
  const speed = 600;
  const velocity = scene.physics.velocityFromRotation(angle, speed);

  bullet.body.setVelocity(velocity.x, velocity.y);

  // GÃ¼llÉ™ 1.5 saniyÉ™yÉ™ yox olsun
  scene.time.delayedCall(1500, () => bullet.destroy());
}
</script>
</body>
</html>
