<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>2D Multiplayer Oyun (At…ô≈üli)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin: 0; background: #111; overflow: hidden; }
    canvas { display: block; margin: auto; }
  </style>

  <!-- Phaser kitabxanasƒ± -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
<script>
const config = {
  type: Phaser.AUTO,
  width: 800,
  height: 600,
  backgroundColor: '#222',
  physics: {
    default: 'arcade',
    arcade: { debug: false }
  },
  scene: { preload, create, update }
};

let player;
let bullets;
let otherBullets = [];
let keys;
let others = {};
let lastFired = 0;

// ‚ö° Server…ô qo≈üul
const socket = io("https://cobu.onrender.com");

const game = new Phaser.Game(config);

function preload() {}

function create() {
  const scene = this;

  // √ñz oyun√ßun (ya≈üƒ±l)
  player = scene.add.circle(400, 300, 20, 0x00ff00);
  scene.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);

  // √ñz g√ºll…ôl…ôrin qrupu
  bullets = scene.physics.add.group();

  // Klaviatura
  keys = scene.input.keyboard.addKeys({
    up: 'W', down: 'S', left: 'A', right: 'D'
  });

  // Maus istiqam…ôti
  scene.input.on('pointermove', pointer => {
    const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
    player.rotation = angle;
  });

  // Maus klik = at…ô≈ü
  scene.input.on('pointerdown', pointer => {
    shoot(scene, pointer);
  });

  // Yeni oyun√ßu
  socket.emit("newPlayer", { x: player.x, y: player.y });

  // Yeni oyun√ßu qo≈üulanda
  socket.on("playerJoined", data => {
    if (!others[data.id]) {
      const other = scene.add.circle(data.x, data.y, 20, 0x0000ff);
      others[data.id] = other;
    }
  });

  // Oyun√ßularƒ±n m√∂vqel…ôri
  socket.on("positions", players => {
    for (let id in players) {
      if (id !== socket.id) {
        if (!others[id]) {
          others[id] = scene.add.circle(players[id].x, players[id].y, 20, 0x0000ff);
        } else {
          others[id].x = players[id].x;
          others[id].y = players[id].y;
        }
      }
    }
  });

  // Oyun√ßu √ßƒ±xanda
  socket.on("playerLeft", id => {
    if (others[id]) {
      others[id].destroy();
      delete others[id];
    }
  });

  // üîπ Dig…ôr oyun√ßularƒ±n atƒ±≈ülarƒ±
  socket.on("playerShoot", data => {
    if (data.id !== socket.id) {
      const bullet = scene.add.circle(data.x, data.y, 5, 0xff0000);
      scene.physics.add.existing(bullet);
      const velocity = scene.physics.velocityFromRotation(data.angle, 600);
      bullet.body.setVelocity(velocity.x, velocity.y);
      otherBullets.push(bullet);
      scene.time.delayedCall(1500, () => bullet.destroy());
    }
  });
}

function update(time) {
  const speed = 250;
  player.body.setVelocity(0);

  if (keys.left.isDown) player.body.setVelocityX(-speed);
  if (keys.right.isDown) player.body.setVelocityX(speed);
  if (keys.up.isDown) player.body.setVelocityY(-speed);
  if (keys.down.isDown) player.body.setVelocityY(speed);

  // √ñz m√∂vqeyini server…ô g√∂nd…ôr
  socket.emit("move", { x: player.x, y: player.y });
}

// üî´ At…ô≈ü funksiyasƒ±
function shoot(scene, pointer) {
  const now = scene.time.now;
  if (now - lastFired < 200) return; // s√ºr…ôtli spamƒ± √∂nl…ô
  lastFired = now;

  const bullet = scene.add.circle(player.x, player.y, 5, 0xff0000);
  scene.physics.add.existing(bullet);

  const angle = Phaser.Math.Angle.Between(player.x, player.y, pointer.x, pointer.y);
  const speed = 600;
  const velocity = scene.physics.velocityFromRotation(angle, speed);
  bullet.body.setVelocity(velocity.x, velocity.y);

  // üîπ Server…ô bildir ki, m…ôn at…ô≈ü a√ßdƒ±m
  socket.emit("shoot", { x: player.x, y: player.y, angle });

  // G√ºll…ô 1.5 saniy…ôd…ôn sonra yox olsun
  scene.time.delayedCall(1500, () => bullet.destroy());
}
</script>
</body>
</html>
