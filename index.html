<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CanlÄ± YazÄ±ÅŸma + ÅÉ™xsi mesajlar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {background:#111;color:#fff;font-family:sans-serif;margin:0;padding:10px;display:flex;flex-direction:column;align-items:center;height:100vh;}
    #messages, #privateBox {flex:1;width:100%;max-width:600px;background:#222;border-radius:10px;padding:10px;overflow:auto;margin-bottom:10px}
    #inputArea {display:flex;width:100%;max-width:600px}
    input {flex:1;padding:10px;border:none;border-radius:10px 0 0 10px}
    button {padding:10px;border:none;background:#28a745;color:white;border-radius:0 10px 10px 0;cursor:pointer}
    #users {background:#1a1a1a;width:100%;max-width:600px;padding:10px;border-radius:10px;margin-bottom:10px;}
    .user {padding:6px;border-bottom:1px solid #333;cursor:pointer}
    .user:hover {background:#333}
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <h2>ğŸ’¬ CanlÄ± YazÄ±ÅŸma â€” Google ilÉ™</h2>

  <div id="userInfo">
    <span id="who">GiriÅŸ olunmayÄ±b</span>
    <button id="loginBtn">Google ilÉ™ daxil ol</button>
    <button id="logoutBtn" style="display:none">Ã‡Ä±xÄ±ÅŸ</button>
  </div>

  <div id="users"></div>

  <div id="messages"></div>

  <div id="privateBox" style="display:none;">
    <h4 id="privateWith"></h4>
    <div id="privateMsgs"></div>
  </div>

  <div id="inputArea">
    <input id="msgInput" type="text" placeholder="Mesaj yaz..." />
    <button onclick="sendMessage()">GÃ¶ndÉ™r</button>
  </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDD0ZmMgCNh7ibhUTf8aKZ-Vd6xyDHBThU",
    authDomain: "cobu-chat-5dab7.firebaseapp.com",
    projectId: "cobu-chat-5dab7",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const socket = io("https://cobu.onrender.com");

  const who = document.getElementById("who");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const messagesDiv = document.getElementById("messages");
  const usersDiv = document.getElementById("users");
  const msgInput = document.getElementById("msgInput");
  const privateBox = document.getElementById("privateBox");
  const privateWith = document.getElementById("privateWith");
  const privateMsgs = document.getElementById("privateMsgs");

  let myId = null;
  let targetId = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      who.textContent = `${user.displayName} (${user.email})`;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      socket.emit("registerUser", { name: user.displayName, email: user.email });
    } else {
      who.textContent = "GiriÅŸ olunmayÄ±b";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  });

  loginBtn.onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  };
  logoutBtn.onclick = () => auth.signOut();

  socket.on("connect", () => { myId = socket.id; });

  socket.on("userList", list => {
    usersDiv.innerHTML = "<b>ğŸ§‘ Ä°stifadÉ™Ã§ilÉ™r:</b><br>";
    for (let id in list) {
      if (id === socket.id) continue;
      const u = list[id];
      const div = document.createElement("div");
      div.className = "user";
      div.textContent = u.name + " (" + u.email + ")";
      div.onclick = () => startPrivateChat(id, u.name);
      usersDiv.appendChild(div);
    }
  });

  socket.on("chatMessage", msg => {
    const p = document.createElement("p");
    p.innerHTML = `<b>${msg.name}</b>: ${msg.text}`;
    messagesDiv.appendChild(p);
  });

  socket.on("privateMessage", msg => {
    privateBox.style.display = "block";
    privateWith.textContent = "ğŸ’Œ " + msg.name + " ilÉ™ yazÄ±ÅŸma";
    const p = document.createElement("p");
    p.textContent = `${msg.name}: ${msg.text}`;
    privateMsgs.appendChild(p);
  });

  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;
    const user = auth.currentUser;
    if (targetId) {
      socket.emit("privateMessage", { to: targetId, text });
      const p = document.createElement("p");
      p.textContent = `SÉ™n: ${text}`;
      privateMsgs.appendChild(p);
    } else {
      socket.emit("chatMessage", { text, name: user.displayName });
    }
    msgInput.value = "";
  }

  function startPrivateChat(id, name) {
    targetId = id;
    privateBox.style.display = "block";
    privateWith.textContent = "ğŸ’Œ " + name + " ilÉ™ yazÄ±ÅŸma";
    privateMsgs.innerHTML = "";
  }
</script>
</body>
</html>
